---
title: "Gas分析"
date: 2020-11-28T10:35:22+08:00
draft: false
summary: "ethereum gas 花费总结"
tags: [ethereum, gas]
---

> 本文记录了ethereum中常见的gas花费，以及一些常见的概念，后面还介绍了有关gas的一些攻击行为。

### 外部账户和合约账户

以太坊中拥有两种账户：

	* 外部账户
	* 合约账户

#### 外部账户

外部账户拥有以下特性：

* 有一个以太坊余额
* 可以发送交易（以太币转账或者调用合约代码）
* 通过私钥控制
* 没有相关联的合约代码

#### 合约账户

合约账户拥有以下特性：

* 有一个以太币的余额
* 有相互关联的代码
* 代码执行是通过交易或者其它合约的call来激活
* 在链上有自己的state永久存储空间

以太坊上的各种行动都是由账户发送的交易激活，每次合约账户的代码被调用，合约代码会被以太坊虚拟机在每一个参与网络的节点上运行，产生新的区块。



### 交易和消息

#### 交易

交易，在以太坊中指代一个被签名的存储消息的数据包在区块链上从一个外部拥有账户发送至另外一个账户的过程。一笔交易包含以下内容：

- 这个消息的接收者
- 一个签名，用来证明发送者有意向通过区块链向接收者发送消息
- 价值域 - 从发送方转移到接受方的wei (ether/10^18) 的数量
- 一个可选的数据域，用来储存发送给合约的消息
- 一个GASLIMIT值，代表了这个交易的执行最多被允许使用的计算步骤
- 一个GASPRICE值，代表了交易发送者愿意支付的gas费用。一个单位的gas表示了执行一个基本指令，例如一个计算步骤

#### 消息

合约具备发送“消息”道其它合约的能力。消息是一个永不串行且只在以太坊执行环境中存在的虚拟对象，他们可以被理解为合约间的“函数调用”。

- 明确的消息发送者
- 消息的接收者
- 一个可选的数据域，这是合约实际上的输入数据
- 一个GASLIMIT值，用来限制这个消息出发的代码执行可用的最大gas数量

总的来说消息是由合约账户产生，交易是由外部账户生成。当合约正在执行的代码中运行CALL或者DELEGATECALL等指令时，会生成一个消息，有时候“消息”也会被称为内部交易，与一个交易类似，一个消息会调用指定合约账户的指定代码。注意“消息”和“交易”两个概念的区别。

### gas

gas是交易的字节码在以太坊虚拟机中运行过程中消耗的费用，每一笔交易会产生特定的字节码，每一个字节码对应不同的gas消耗。交易的执行会在所有节点中被多次重放，这个事实使得交易执行的消耗变得昂贵，所以这也敦促大家将能在链下进行的运算都不放到区块链上进行。

**gas Used**: 该交易消耗的总gas数量

**gas limit**: 代表了这个交易的执行最多被允许使用的计算步骤。

**gas Price**: 该交易中单位gas的价格，交易费用=gasUsed*gasPrice

**估算交易费用**： 交易费用=gasUsed*gasPrice

**区块的gas limit**：区块gas limit是单个区块允许的最多gas总量，以此可以用来决定单个区块中能打包多少笔交易。例如，我们有5笔交易的gas limit分别是10、20、30、40和50.如果区块gas limit是100，那么前4笔交易就能被成功打包进入这个区块。矿工有权决定将哪些交易打包入区块。所以，另一个矿工可以选择打包最后两笔交易进入这个区块（50+40），然后再将第一笔交易打包（10）。如果你尝试将一个会使用超过当前区块gas limit的交易打包，这个交易会被网络拒绝，你的以太坊客户端会反馈错误”交易超过区块gas limit”。[以下例子是来自于以太坊StackExhcange的帖子](https://ethereum.stackexchange.com/questions/7359/are-gas-limit-in-transaction-and-block-gas-limit-different)。

目前区块的gas limit是[4,712,357 gas，数据来自于ethstats.net](https://ethstats.net/)，这表示着大约224笔转账交易（gas limit为21000）可以被塞进一个区块（区块时间大约在15-20秒间波动）。[这个协议允许每个区块的矿工调整区块gas limit，任意加减 1/2024（0.0976%）。](https://www.reddit.com/r/ethereum/comments/6g6tww/there_are_hundreds_or_even_thousands_of_pending/dinzrgq/)

### 以太坊上的DDOS攻击

当以太坊网络上持续地出现全满区块并且有大量交易在网络上待处理时就会出现所谓的DoS情况。同时，矿工有权利根据交易费选择打包哪些交易。如果当时队列中（交易池中）有上千笔交易正在等待打包，那么就有可能造成几个小时的非正常交易延迟。DDoS可能是恶意的也有可能是非恶意的。

#### 恶意的DoS

上个秋天，以太坊被某人或某个团体攻击了，通过大量制造垃圾交易。这次攻击在如下[博客有介绍](https://blog.ethereum.org/2016/10/18/faq-upcoming-ethereum-hard-fork/)：

```
攻击者通过在他们的智能合约中反复的调用某些命令来让客户端难以处理这些计算，但是这些命令都只消耗少量的gas所以调用起来十分廉价。
```

在这次攻击中，矿工[被要求降低gas limit到150万](https://blog.ethereum.org/2016/09/22/transaction-spam-attack-next-steps/)，在后来的[另一次事件中更改到了200万](https://www.reddit.com/r/ethereum/comments/58aelh/attention_miners_recommending_miners_lower_the/)。也有几次其他的事件要求矿工在网络被攻击时降低区块gas limit。

#### 非恶意的DOS

非恶意的DoS其实就是当网络面临海量交易时需要比平常更多的时间来处理一笔交易。最近由于ICO的流行，以太坊网络多次被交易填满。Infura的朋友们写过[一篇与此相关的技术分析文章](https://blog.infura.io/when-there-are-too-many-pending-transactions-8ec1a88bc87e)。

#### gas limit在区块被填充满的是为什么不会自动调整？

**矿工们没有使用gas limit动态调整的功能，区块gas limit的值是通过以太坊协议决定的。**

以太坊协议中存在着让矿工可以通过投票来决定gas limit的机制，所以区块容量不需要经过硬分叉就可以调整。最初，这个机制和另一个默认策略是绑定在一起的，即矿工默认投票使区块gas limit至少有470万，并且趋向于最近1024个区块gas使用量的1.5倍。这使得区块容量会根据需求来自动上升，同时也有一个可用来防御垃圾交易的限制。

就像”恶意的DoS”部分说的，在历史上有几次矿工因为攻击的原因不得不使用非默认设置来帮助降低攻击造成的影响。但现在的问题是矿池在攻击之后并没有将设置改回默认设置。大约一个月前，[矿工被要求改变gas limit和gas price设置来再次加入gas limit动态调整功能](https://www.reddit.com/r/ethereum/comments/6ehp60/recommendations_to_miners_to_change_gas_limit_and/)。因为最近的代币销售火爆导致很多区块被填满并且区块链交易堵塞。

[ETH Gas Station](http://ethgasstation.info/index.php)是一个人们可以查阅[最新区块gas limit设置的网站](http://ethgasstation.info/minerVotes.php)。

### gas 相关的攻击

1. 关于以太坊上的交易，最基本的事实就是：Gas 费用（即交易手续费）是由 *交易发送方* 来支付的——也就是签名该交易的账户来支付。

   这里就潜藏着一个攻击向量，因为：

   1. 一个攻击者可以诱使你发出交易，并且
   2. 他们可以让这笔交易耗费大量的 Gas

   第一个条件不难达成。如果我在中心化交易所（例如：Coinbase）里有个账户，我可以要求交易所转账到我指定的地址。交易所的标准实现就包含了从自己的账户中发送交易，但这样做的时候，他们就要支付 Gas 费用。

   要满足第二个条件对智能合约开发者来说也是小菜一碟。而智能合约里可以写入任意代码、对发过来的交易作出回应。

2. 因为以太坊上的计算资源是有限的，单个区块可用的 Gas 是有个上限的，这就是所谓的“区块 Gas 上限”（译者注：交易和区块的 Gas 用量上限英文都为 Gas Limit，翻译时有意区分）。矿工要收集交易并打包到区块里，因为矿工们可以得到 Gas 费用，所以他们会尽可能高效利用区块的 Gas 空间（即让交易的 Gas Limit 总和尽可能接近区块 Gas 上限）（译者注：只是理论上如此，实际上矿工的打包策略非常多样）。**本文写作时，以太坊主网的 Gas 上限约为 800 万。一笔交易的 Gas 耗用量如果大于这个上限，是根本没法被打包的。这可以成为一个拒绝服务式攻击向量——攻击者可以让一个合约没办法再运行。**

3. 目前的一些dapp引用出现“中继”代理发送交易。作为规则“发交易者付 Gas 费”的变通方案，我已经看到近期许多关于所谓“[元交易](https://medium.com/@austin_48503/ethereum-meta-transactions-90ccf0859e84)（meta transaction）”的讨论。一笔元交易非常像一笔交易，但可以由第三方来中继（relay）。该第三方中继者才是实际上发出交易的账户，因此 Gas 费用是由他们来支付的。

   在这种解决方案中，中继者变成了一种罕见的攻击向量。作为交易的实际发送者，他们可以指定交易的 Gas Limit。只要给出的 Gas 太少，他们就可以让交易失败。如果他们有足够的激励来做这件事，这就会成为一个问题，正如在下面这个合约中所示的那样：

### 参考文献

* https://tsaiyee.com/docs/blockchain/ethereum-account-transaction-gas/
* https://ethfans.org/posts/silent-but-vulnerable-ethereum-gas-security-concerns